<!doctype html>
<html>

<head>
	<title>Memory</title>
</head>

<link rel="stylesheet" type="text/css" href="css/css.css">
<link href='http://fonts.googleapis.com/css?family=Philosopher:400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:300' rel='stylesheet' type='text/css'>

<body>
	<h1>Memory</h1>

	<div id="settings">
		<form>
			Number of Rows: <input type="text" id="numberRows"/>
			<br />
			Number of Columns: <input type="text" id="numberColumns"/>
			<br />
			<div id="submitSettings">
				Submit
			</div>
		</form>
	</div>

	<br />

	<ul id="grid"></ul>

	<script>

		// TODO:
		// Make this look better...
		// Allow user to select # of rows & columns in grid
		// Randomize cards
		// Fix 3rd click to restart bug - this has to do with onlick (3) / order of events
		// Limit # of turns user has to complete game
		// Display score
		// Do something interesting if user wins game
		// Do something interesting if user does not win game + create new game
		// Add game history/stats to go backwards
		// Allow multi-player games
		// Make width of Grid UL varibale according to # of rows (width = # columns X 100px + 60 extra?)
		//Add the Card.type & .status to the html elements as data-flip
		// Take the type of Card & extenalize info in form of data-flip
		// Have different deck types

		var myApp = {};

		//CARD OBJECT
		var Card = function Card(status, id){
			this.status = status; //active or inactive
			this.id = id;
			this.type;
		}

		Card.prototype.setType = function(){
			if(this.type){
				return this.type;
			}
			else{
				var types = ["king", "queen", "joker"];
				var randomNumber = Math.round(Math.random() * 2);
				
				this.type = types[randomNumber];
				return types[randomNumber];
			}
		};

		Card.prototype.physicalCard = function(){
			var listItem = document.createElement("li");
			var divItem = document.createElement("div");
			
			divItem.className = "box";
			divItem.setAttribute("data-status", this.status);
			divItem.setAttribute("data-cardid", this.id);

			listItem.appendChild(divItem);
			return listItem;
		};


		//GRID OBJECT
		var Grid = function Grid(dimensions){
			this.rows = dimensions[0];
			this.columns = dimensions[1];
		}
		
		Grid.prototype.build = function(){
			var deck = [];
			var totalBoxes = parseInt(this.rows) * parseInt(this.columns);
			var gridList = document.getElementById("grid");

			this.removeGrid();
				
			for(var i = 0; i < totalBoxes; i++){

				var cardBuilt = new Card("inactive", i);
				cardBuilt.setType();
				console.log(cardBuilt.type);
				gridList.appendChild(cardBuilt.physicalCard());

				deck.push(cardBuilt);
			}

			this.setWidth();

			myApp.deck = deck; //ermmm
			// return deck;
		};

		Grid.prototype.setWidth = function(){
			var gridList = document.getElementById("grid");
			var x = (this.columns * 100) + 60;
			gridList.style.width = x.toString() + "px";

		};

		Grid.prototype.removeGrid = function(){
			var gridList = document.getElementById("grid");
			while(gridList.firstChild){
				gridList.removeChild(gridList.firstChild);
			}
		};

		Grid.prototype.getDeck = function(){
			return this.deck;
		}


		//EVENTS
		document.getElementById('submitSettings').addEventListener('click', buildGrid, false);
		document.getElementById('grid').addEventListener('click', queryActiveCards, false);
		document.getElementById('grid').addEventListener('click', revealCard, false);
		document.getElementById('grid').addEventListener('click', fadeOutCard, false);

		function getGridDimensions(){
			var rows = document.getElementById("numberRows").value || 5;
			var columns = document.getElementById("numberColumns").value || 5;

			return [rows, columns]; 
		}

		function buildGrid(){
			var dimensions = getGridDimensions();
			var newGrid = new Grid(dimensions);
			newGrid.build();
		}

		function getDataCardId(e){
			var dataCardId = e.toElement.attributes['data-cardid'].nodeValue;
			return dataCardId;
		}

		function revealCard(e){
			var cardId = getDataCardId(e);
			var cardShape = myApp.deck[cardId].type;
			console.log("cardShape", cardShape);
			var card = e.target;

			var changeStat = toggleCardStatus(myApp.deck[cardId].status, cardId);

			switch(cardShape){
				case "king":
					setCSS(card, "backgroundImage", "url('img/king.jpg')");//make this map to the cardShape.jpg
					break;
				case "queen":
					setCSS(card, "backgroundImage", "url('img/queen.jpg')");
					break;
				default:
					setCSS(card, "backgroundImage", "url('img/joker.jpg')");
					break;
			}

		}

		function toggleCardStatus(cardStats, cardId){
			var targetedCard = myApp.deck[cardId];

			if(cardStats === "inactive"){
				targetedCard.status = "active";
			}
			else{
				targetedCard.status = "inactive";
			}
		}

		function fadeOutCard(e){
			var cardsActive = queryActiveCards(e);
			var IdNumber = getDataCardId(e);

			console.log("there are " + cardsActive.length + " active cards");
			
			if(cardsActive.length === 1){

				setTimeout(function(){
					setCSS(getBoxElemByNumber(IdNumber), "backgroundImage", "");
					toggleCardStatus("active", IdNumber);
				}, 900);
			}
			else{
				if(cardsMatch(cardsActive)){
					// setCSS(cardsActive[0], "border", "1px solid red");
					// setCSS(cardsActive[1], "border", "1px solid blue");
					// setCSS(cardsActive[0], "background", "#000");
					//if it's a match, find last clicked fading card, clearTimeout the fade & then set it to active again?
				} 
				console.log("no fade applied to this 2nd card... but FIRST card will fade...");
			}
		}

		function getBoxElemByNumber(IdNumber){
			var boxes = document.querySelectorAll('.box');
			for(var i = 0; i < boxes.length; i++){
				if(boxes[i].getAttribute("data-cardid") === IdNumber){
					return boxes[i];
				}
				else{ continue; }
			}
		}

		function queryActiveCards(e){ //determines which cards have been flipped
			var targetCard = getDataCardId(e);
			var activeCards = [];

			for(var i = 0; i < myApp.deck.length; i++){
				if(myApp.deck[i].status === "active"){
					activeCards.push(myApp.deck[i]);
				}
				else{ continue; }
			}

			if(activeCards.length === 2){
				if(cardsMatch(activeCards)){
					console.log("the cards match");
				}
				else{
					clearGrid();
				}

			}
			if(activeCards.length > 2){
				console.log("the fuq are there more than 2 active cards for?");
				clearGrid();
			}

			return activeCards;
		}


		function cardsMatch(activeCards){ //determines if there is a match among flipped cards
			if(activeCards[0].type ===  activeCards[1].type){
				console.log("MATCH");
				alert("Congratulations, you won!");
				//remove the click event listeners to prevent user from continuing to play?
				//give option to begin new game?
				return true;
			}
			else{ 
				console.log("NO MATCH");
				return false;
			}
		}


		function clearGrid(){
			var boxes = document.querySelectorAll('.box');
			for(var i = 0; i < boxes.length; i++){
				boxes[i].style.background = "";
			}
		}


		function setCSS(target, property, value){
			var elementStyle = target.style;
			elementStyle[property.toString()] = value.toString();
		}


	</script>
</body>

</html>