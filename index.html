<!doctype html>
<html>

<head>
	<title>Memory</title>
</head>

<style>
#grid{
	width: 370px;
	list-style: none;
}
.box{
	width: 100px;
	height: 150px;
	border: 1px solid #ccc;
	float: left;
	background-position: center;
	background-repeat: no-repeat;
}
.box:hover{
	background: #ccc;
}
</style>

<body>
	<ul id="grid">
		<li><div class="box" data-flip="king"></div></li>
		<li><div class="box" data-flip="circle"></div></li>
		<li><div class="box" data-flip="queen"></div></li>
		<li><div class="box" data-flip="circle"></div></li>
		<li><div class="box" data-flip="circle"></div></li>
		<li><div class="box" data-flip="king"></div></li>
		<li><div class="box" data-flip="circle"></div></li>
		<li><div class="box" data-flip="circle"></div></li>
		<li><div class="box" data-flip="queen"></div></li>
	</ul>

	<script>

		// TODO:
		// Make this look better...
		// Allow user to select # of rows & columns in grid
		// Randomize cards
		// Fix 3rd click to restart bug - this has to do with onlick (3) / order of events
		// Limit # of turns user has to complete game
		// Do something interesting if user wins game
		// Do something interesting if user does not win game + create new game
		// Add game history/stats to go backwards
		// Allow multi-player games

		//EVENTS
		document.getElementById('grid').addEventListener('click', queryActiveCards, false);
		document.getElementById('grid').addEventListener('click', getDataFlip, false);
		document.getElementById('grid').addEventListener('click', revealCard, false);
		document.getElementById('grid').addEventListener('click', fadeOutCard, false);

		function getDataFlip(e){
			var dataFlip = e.toElement.attributes['data-flip'].nodeValue;
			//console.log(dataFlip, e);
			return dataFlip;
		}

		function revealCard(e){
			var cardShape = getDataFlip(e);
			var card = e.target;

			switch(cardShape){
				case "king":
					setCSS(card, "backgroundImage", "url('img/king.jpg')");
					console.log(cardShape);
					break;
				case "queen":
					setCSS(card, "backgroundImage", "url('img/queen.jpg')");
					break;
				default:
					setCSS(card, "backgroundImage", "url('img/joker.jpg')");
					console.log(cardShape, "no card data");
					break;
			}

		}

		function queryActiveCards(e){ //determines which cards have been flipped
			var boxes = document.querySelectorAll('.box');
			var activeBoxes = [];

			for(var i = 0; i < boxes.length; i++){
				if(boxes[i].style.background !== ""){
					activeBoxes.push(boxes[i]);
				}
				else{ continue; }
			}

			if(activeBoxes.length >= 2){ //FIXME
				if(cardsMatch(activeBoxes)){
					console.log("match confirmed, don't remove these");
				}
				else{
					clearGrid();
				}
			}

			return activeBoxes;
		}


		function cardsMatch(activeCards){ //determines if there is a match among flipped cards
			if(activeCards[0].dataset.flip ===  activeCards[1].dataset.flip){
				console.log("MATCH");
				alert("Congratulations, you won!");
				return true;
			}
			else{ 
				console.log("NO MATCH");
				return false;
			}
		}


		function clearGrid(){
			var boxes = document.querySelectorAll('.box');

			for(var i = 0; i < boxes.length; i++){
				boxes[i].style.background = "";
			}
			console.log("board cleared");
		}


		function setCSS(target, property, value){
			var elementStyle = target.style;

			//cache current style
			//gameHistory.logBackgroundImgHistory(elementStyle[property.toString()]);

			elementStyle[property.toString()] = value.toString();
		}


		var gameHistory = {
			numberSteps: 0,
			iterate: function(x){
				this.numberSteps += x;
				return this.numberSteps;
			},
			logBackgroundImgHistory: function(currentStyle){
				var cache = cache || [];
				var uniqueKey = this.iterate(1);

				cache[uniqueKey] = currentStyle;
				console.log(cache);
			}
		}



		function fadeOutCard(e){
			var cardsActive = queryActiveCards(e);
			
			if(cardsActive.length === 1){
				setTimeout(function(){
					//NICE FADE
					//e.target.style.transition = "opacity 1.0s linear 0s"; 
					//e.target.style.opacity = "0";
				
					//e.target.style.transition = "backgroundImage 1.0s linear 0s"; 
					setCSS(e.target, "backgroundImage", "");
				}, 900);
			}
			else{ console.log("not one card, don't fade"); }
		}


	</script>
</body>

</html>